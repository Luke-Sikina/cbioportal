<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.persistence.mybatis.TreatmentMapper">
    <sql id="eventSelect">
        (SELECT
            cancer_study.CANCER_STUDY_IDENTIFIER as study${sequenceIndex},
            clinical_event_data.KEY as key${sequenceIndex},
            clinical_event_data.VALUE as event${sequenceIndex},
            patient.STABLE_ID as patientId${sequenceIndex},
            clinical_event.START_DATE as start${sequenceIndex},
            ifnull(clinical_event.STOP_DATE, clinical_event.START_DATE) as stop${sequenceIndex}
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.CLINICAL_EVENT_ID = clinical_event_data.CLINICAL_EVENT_ID
            INNER JOIN patient ON clinical_event.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN sample ON patient.INTERNAL_ID = sample.PATIENT_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        WHERE
            cancer_study.CANCER_STUDY_IDENTIFIER IN
            <foreach item="studyId" collection="studyIds" open="(" separator="," close=")">
                #{studyId}
            </foreach> AND
            clinical_event_data.KEY='AGENT' AND
            clinical_event_data.VALUE = ${eventValue}) as event${sequenceIndex}
    </sql>
    <select id="getEventTimeline" resultType="java.lang.String">
        SELECT
            distinct(patientId999)
        FROM
            <include refid="eventSelect">
                <property name="sequenceIndex" value="999"/>
                <property name="eventValue" value="#{firstEventValue}"/>
            </include>
            <foreach item="item" index="index" collection="eventValues" open="" separator=" " close="">
                JOIN
                <include refid="eventSelect">
                    <property name="sequenceIndex" value="#{index}"/>
                    <property name="eventValue" value="#{item}"/>
                </include>
                ON (event999.patientId999 = event#{index}.patientId#{index})
            </foreach>
        WHERE
            event999.stop999
            <foreach item="item" index="index" collection="eventValues" open="" separator=" " close="">
                &lt; event#{index}.start#{index} AND event#{index}.stop#{index}
            </foreach>
            &lt; 99999999999
    </select>
    
    <select id="getAllTreatments" resultType="org.cbioportal.model.Treatment">
        SELECT
            clinical_event_data.VALUE as treatment,
            patient.STABLE_ID as patientId,
            cancer_study.CANCER_STUDY_IDENTIFIER as studyId,
            clinical_event.START_DATE as start,
            clinical_event.STOP_DATE as stop
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.CLINICAL_EVENT_ID = clinical_event_data.CLINICAL_EVENT_ID
            INNER JOIN patient ON clinical_event.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN sample ON patient.INTERNAL_ID = sample.PATIENT_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        <include refid="where"/>
            AND clinical_event_data.KEY = 'AGENT'
    </select>

    <select id="getAllSamples" resultType="org.cbioportal.model.ClinicalEventSample">
        SELECT
            sample.STABLE_ID as sampleId,
            patient.STABLE_ID as patientId,
            cancer_study.CANCER_STUDY_IDENTIFIER as studyId,
            clinical_event.START_DATE as timeTaken
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.CLINICAL_EVENT_ID = clinical_event_data.CLINICAL_EVENT_ID
            INNER JOIN patient ON clinical_event.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN sample ON clinical_event_data.VALUE = sample.STABLE_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        <include refid="where"/>
            AND clinical_event_data.KEY = 'SAMPLE_ID'
    </select>

    <select id="getAllShallowSamples" resultType="org.cbioportal.model.ClinicalEventSample">
        SELECT
            sample.STABLE_ID as sampleId,
            patient.STABLE_ID as patientId,
            cancer_study.CANCER_STUDY_IDENTIFIER as studyId
        FROM
            sample
            INNER JOIN patient ON sample.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        <include refid="where"/>
    </select>

    <select id="getAllUniqueTreatments" resultType="java.lang.String">
        SELECT 
            DISTINCT clinical_event_data.VALUE
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.CLINICAL_EVENT_ID = clinical_event_data.CLINICAL_EVENT_ID
            INNER JOIN patient ON clinical_event.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN sample ON patient.INTERNAL_ID = sample.PATIENT_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        <include refid="where"/>
            AND clinical_event_data.KEY = 'AGENT'
    </select>

    <select id="getTreatmentCount" resultType="java.lang.Integer">
        SELECT
            COUNT(clinical_event.PATIENT_ID)
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.CLINICAL_EVENT_ID = clinical_event_data.CLINICAL_EVENT_ID
            INNER JOIN patient ON clinical_event.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN sample ON patient.INTERNAL_ID = sample.PATIENT_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        <include refid="where"/>
            AND clinical_event_data.KEY = 'AGENT'
    </select>

    <select id="getSampleCount" resultType="java.lang.Integer">
        SELECT
            COUNT(sample.STABLE_ID)
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.CLINICAL_EVENT_ID = clinical_event_data.CLINICAL_EVENT_ID
            INNER JOIN patient ON clinical_event.PATIENT_ID = patient.INTERNAL_ID
            INNER JOIN sample ON patient.INTERNAL_ID = sample.PATIENT_ID
            INNER JOIN cancer_study ON patient.CANCER_STUDY_ID = cancer_study.CANCER_STUDY_ID
        <include refid="where"/>
            AND clinical_event_data.KEY = 'SAMPLE_ID'
    </select>
    

    <sql id="where">
        <where>
            <if test="sampleIds == null and studyIds != null">
                cancer_study.CANCER_STUDY_IDENTIFIER IN
                <if test="studyIds.isEmpty()">
                    (NULL)
                </if>
                <if test="!studyIds.isEmpty()">
                    <foreach item="item" collection="studyIds" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
            </if>
            <if test="sampleIds != null">
                <if test="@java.util.Arrays@stream(studyIds.toArray()).distinct().count() == 1">
                    cancer_study.CANCER_STUDY_IDENTIFIER = #{studyIds[0]} AND
                    sample.STABLE_ID IN
                    <foreach item="item" collection="sampleIds" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="@java.util.Arrays@stream(studyIds.toArray()).distinct().count() > 1">
                    cancer_study.CANCER_STUDY_IDENTIFIER IN
                        <foreach item="item" collection="@java.util.Arrays@stream(studyIds.toArray()).distinct().collect(@java.util.stream.Collectors@toList())" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                    AND (cancer_study.CANCER_STUDY_IDENTIFIER, sample.STABLE_ID) IN
                    <foreach index="i" collection="sampleIds" open="(" separator="," close=")">
                        (#{studyIds[${i}]}, #{sampleIds[${i}]})
                    </foreach>
                </if>
            </if>
        </where>
    </sql>
</mapper>